#! /bin/sh -f
#\
mkdir -p logfiles
#\
mkdir -p patterns
#\
exec tessent -shell -log logfiles/$0.log -replace -dofile "$0"

set PDK_ROOT ../../../tech


set_context patterns -scan

# Specify where the tsdb_outdir is to be located, default is at the current working directory
set_tsdb_output_directory ../tsdb_outdir

# Read Tessent Library
read_cell_library ${PDK_ROOT}/tessent/ihp-sg13g2_stdcell.tcelllib
read_cell_library ${PDK_ROOT}/tessent/ihp-sg13g2_io.tcelllib

read_cell_library ${PDK_ROOT}/tessent/memories/RM_IHPSG13_1P_256x64_c2_bm_bist.atpglib

## Reads in the scan inserted netlist/design
read_design croc_soc_GpioCount32  -design_id gate3 -verbose
set_current_design croc_soc_GpioCount32

# Specify set_current_mode using a different name than what was used during scan insertion with add_scan_mode command
set_current_mode edt_int_transition -type internal

report_dft_signals

# Extract the internal mode specified during scan insertion to run ATPG
import_scan_mode int_mode -fast_capture_mode on

set_system_mode analysis
report_clocks
report_pin_const
set_timing_exceptions_handling -error_allowed on
read_sdc ../0.netlist_generation/croc_soc.sdc

set_fault_type transition
set_external_capture_options -pll_cycles 5 [lindex [get_timeplate_list] 0]

report_statistics -detail
# Add more processors to run ATPG
add_processors localhost:4

# Generate Patterns
create_patterns
report_statistics -detail

# Store TCD, flat_model, fault list and patDB format files in the TSDB directory
write_tsdb_data -replace

# Write Verilog patterns for simulation
write_patterns patterns/croc_soc_GpioCount32_transition_parallel.v -verilog -parallel -replace -parameter_list {SIM_KEEP_PATH 1}
set_pattern_filtering -sample_per_type 2
write_patterns patterns/croc_soc_GpioCount32_transition_serial.v -verilog -serial -replace -parameter_list {SIM_KEEP_PATH 1}


# In order to understand the coverage of the faults testable by Internal mode it is necessary to
# eliminate the undetected faults that would otherwise be detected in External mode.  This is done
# by merging the fault list from running the graybox in External mode
read_faults -mode ext_multi_transition -fault_type transition -merge

report_statistics -detail
#calculate final coverage by including the controller chain atpg test

exit

